import React from 'react';
import { useTranslation } from 'react-i18next';
import { Pressable, StyleSheet, Text, View } from 'react-native';
import Animated from 'react-native-reanimated';
import CompletedLessonModal from '@assets/MusicalGym/CompletedLessonModal.svg';
import LockedLessonModal from '@assets/MusicalGym/LockedLessonModal.svg';
import ResultDownArrowSmall from '@assets/MusicalGym/ResultDownArrowSmall.svg';
import ResultUpArrowSmall from '@assets/MusicalGym/ResultUpArrowSmall.svg';
import UncompletedLessonModal from '@assets/MusicalGym/UncompletedLessonModal.svg';
import { useAnimatedBounce } from 'src/hooks';
import {
  MusGymLastPatterns,
  MusGymStep,
} from 'src/services/modules/musical-gym/types';
import { useAppDispatch, useAppSelector } from 'src/store/hooks';
import {
  initialStepsHistory,
  setMusGymActiveStepHistory,
} from 'src/store/musical-gym';
import { Colors } from 'src/theme/v2/Colors';
import { Fonts } from 'src/theme/v2/Fonts';

import { CategoriesLocalDataProps } from '../../helpers';

interface StatisticItemProps {
  value: number;
  labelKey: string;
  pattern?: MusGymLastPatterns | null;
  showEmptyPattern?: boolean;
}

const StatisticItem: React.FC<StatisticItemProps> = ({
  value,
  labelKey,
  pattern,
  showEmptyPattern,
}) => {
  const { t } = useTranslation();

  const renderPatternIcon = () => {
    if (pattern === MusGymLastPatterns.DOWN) {
      return <ResultDownArrowSmall />;
    }
    if (pattern === MusGymLastPatterns.UP) {
      return <ResultUpArrowSmall />;
    }
    if (showEmptyPattern) {
      return <View style={styles.emptySuccessPatternWrapper} />;
    }
    return null;
  };

  return (
    <View style={styles.statisticInfoSubWrapper}>
      {renderPatternIcon()}
      <Text style={[Fonts.mons12Bold, styles.percentTitle]}>
        {Number((value * 100).toFixed(2))}%
      </Text>
      <Text
        style={[Fonts.mons10Regular, styles.percentText]}
        numberOfLines={2}
        adjustsFontSizeToFit
      >
        {t(labelKey)}
      </Text>
    </View>
  );
};

interface HeaderModalListItemProps {
  item: MusGymStep;
  handleCloseModal: () => void;
  index: number;
  activeCategory: CategoriesLocalDataProps;
}

const HeaderModalListItem: React.FC<HeaderModalListItemProps> = ({
  item,
  handleCloseModal,
  index,
  activeCategory,
}) => {
  const { t } = useTranslation();
  const dispatch = useAppDispatch();
  const isExistSuccessPattern =
    item.successRate.last.pattern === MusGymLastPatterns.UP ||
    item.successRate.last.pattern === MusGymLastPatterns.DOWN;

  const musGymActiveStepHistory = useAppSelector(
    state => state.musGymSlice.activeStepHistory ?? initialStepsHistory,
  );

  const getStatusLessonIcon = () => {
    if (!item.available) {
      return <LockedLessonModal />;
    } else if (item.isCompleted) {
      return <CompletedLessonModal />;
    } else {
      return <UncompletedLessonModal />;
    }
  };

  const handleChangeStep = () => {
    if (item.available) {
      const newHistory = { ...musGymActiveStepHistory };
      newHistory[activeCategory.categoryKey] = item.order;
      dispatch(setMusGymActiveStepHistory(newHistory));
      handleCloseModal();
    }
  };

  const animatedStyles = useAnimatedBounce({ index: index });

  return (
    <Animated.View style={[styles.animatedWrapper, animatedStyles]}>
      <Pressable style={styles.wrapper} onPress={handleChangeStep}>
        <View>{getStatusLessonIcon()}</View>
        <View style={styles.stepInfoTitleWrapper}>
          <Text style={[Fonts.mons32Bold]}>{item.order}</Text>
          <Text style={[Fonts.mons12Regular, styles.stepTitle]}>
            {t('musical_gym.header.step')}
          </Text>
        </View>
        {item.available && (
          <View style={styles.contentWrapper}>
            <Text
              style={[Fonts.mons14SemiBold, { maxWidth: 250 }]}
              numberOfLines={1}
              adjustsFontSizeToFit
            >
              {item.title}
            </Text>
            {item.successRate.average !== null &&
            item.successRate.last.successRate !== null ? (
              <View style={styles.statisticInfoWrapper}>
                <StatisticItem
                  value={item.successRate.last.successRate ?? 0}
                  labelKey="musical_gym.header.last_try"
                  pattern={item.successRate.last.pattern}
                />
                <StatisticItem
                  value={item.successRate.best ?? 0}
                  labelKey="musical_gym.header.best"
                  showEmptyPattern={isExistSuccessPattern}
                />
                <StatisticItem
                  value={item.successRate.average ?? 0}
                  labelKey="musical_gym.header.average"
                  showEmptyPattern={isExistSuccessPattern}
                />
              </View>
            ) : (
              <View style={styles.statisticInfoWrapper}>
                <Text style={[Fonts.mons12Regular]}>
                  {t('musical_gym.header.start_train')}
                </Text>
              </View>
            )}
          </View>
        )}
      </Pressable>
    </Animated.View>
  );
};

export default HeaderModalListItem;

const styles = StyleSheet.create({
  animatedWrapper: {
    width: '100%',
    paddingVertical: 16,
  },
  wrapper: {
    width: '100%',
    display: 'flex',
    flexDirection: 'row',
    alignItems: 'center',
    gap: 16,
  },
  contentWrapper: {
    flex: 1,
    minWidth: 0,
  },
  stepInfoTitleWrapper: {
    display: 'flex',
    flexDirection: 'column',
    justifyContent: 'center',
    alignItems: 'center',
  },
  stepTitle: {
    marginTop: -7,
  },
  percentText: {
    color: Colors.secondary,
    textAlign: 'center',
  },
  statisticInfoWrapper: {
    width: '100%',
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
  },
  emptySuccessPatternWrapper: {
    width: 14,
    height: 14,
  },
  statisticInfoSubWrapper: {
    flex: 1,
    minWidth: 0,
    alignItems: 'center',
    paddingRight: 8,
    paddingTop: 6,
    gap: 3,
  },
  percentTitle: {
    color: Colors.text.main,
    maxWidth: 41,
  },
});
